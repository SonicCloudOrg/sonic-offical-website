import{_ as s,o as n,c as a,a as l}from"./app.57a3dbd1.js";const i=JSON.parse('{"title":"自定义脚本","description":"","frontmatter":{"contributors":["ZhouYixun","mmagi","upengfei"]},"headers":[{"level":2,"title":"一、Groovy(Java)脚本 （推荐🔥）","slug":"一、groovy-java-脚本-推荐🔥","link":"#一、groovy-java-脚本-推荐🔥","children":[{"level":3,"title":"能力介绍","slug":"能力介绍","link":"#能力介绍","children":[]},{"level":3,"title":"输出日志到测试报告","slug":"输出日志到测试报告","link":"#输出日志到测试报告","children":[]},{"level":3,"title":"引用全局参数","slug":"引用全局参数","link":"#引用全局参数","children":[]},{"level":3,"title":"获取设备序列号","slug":"获取设备序列号","link":"#获取设备序列号","children":[]},{"level":3,"title":"断言","slug":"断言","link":"#断言","children":[]},{"level":3,"title":"退出Driver","slug":"退出driver","link":"#退出driver","children":[]},{"level":3,"title":"示例脚本展示","slug":"示例脚本展示","link":"#示例脚本展示","children":[]}]},{"level":2,"title":"二、Python脚本","slug":"二、python脚本","link":"#二、python脚本","children":[{"level":3,"title":"能力介绍","slug":"能力介绍-1","link":"#能力介绍-1","children":[]},{"level":3,"title":"前置环境","slug":"前置环境","link":"#前置环境","children":[]},{"level":3,"title":"可用参数","slug":"可用参数","link":"#可用参数","children":[]},{"level":3,"title":"退出Driver","slug":"退出driver-1","link":"#退出driver-1","children":[]},{"level":3,"title":"示例脚本展示","slug":"示例脚本展示-1","link":"#示例脚本展示-1","children":[]}]},{"level":2,"title":"导入模板","slug":"导入模板","link":"#导入模板","children":[]},{"level":2,"title":"使用规范与建议","slug":"使用规范与建议","link":"#使用规范与建议","children":[]}],"relativePath":"doc/doc-script.md","lastUpdated":1716537034000}'),o={name:"doc/doc-script.md"},p=l(`<h1 id="自定义脚本" tabindex="-1">自定义脚本 <a class="header-anchor" href="#自定义脚本" aria-hidden="true">#</a></h1><p>使用自定义脚本执行UI自动化。（该功能需升级至Sonic v2.0.0版本）</p><h2 id="一、groovy-java-脚本-推荐🔥" tabindex="-1">一、Groovy(Java)脚本 （推荐🔥） <a class="header-anchor" href="#一、groovy-java-脚本-推荐🔥" aria-hidden="true">#</a></h2><h3 id="能力介绍" tabindex="-1">能力介绍 <a class="header-anchor" href="#能力介绍" aria-hidden="true">#</a></h3><div class="tip custom-block"><p class="custom-block-title">Sonic官方推荐原因</p><ol><li>可以直接使用Agent所有内置函数与变量。</li><li>Groovy引擎可以兼容Java语言，能与Java很好的结合，可以直接运行Java代码或者Groovy与Java混用。</li><li>Groovy语法简单，容易扩展，学习门槛低。</li><li>直接运行在JVM上，无需配置额外环境。</li><li>等等...</li></ol></div><h4 id="默认内置内容" tabindex="-1">默认内置内容 <a class="header-anchor" href="#默认内置内容" aria-hidden="true">#</a></h4><p>执行自定义脚本前，会将基础StepHandler传入Groovy引擎。</p><p>包括但不限于：</p><ol><li>log对象，可以操作测试报告输出文本</li><li>androidDriver，可以操作UIAutomator2-Server</li><li>iosDriver，可以操作Wda</li><li>全局参数，可以对全局参数进行存取</li><li>Sonic的自定义步骤，可以直接复用</li><li>其他，包括PocoDriver、设备信息等等</li></ol><div class="tip custom-block"><p class="custom-block-title">更多内置方法可查看</p><p><a href="https://github.com/SonicCloudOrg/sonic-agent/blob/main/src/main/java/org/cloud/sonic/agent/tests/handlers/AndroidStepHandler.java" target="_blank" rel="noreferrer">AndroidStepHandler</a></p><p><a href="https://github.com/SonicCloudOrg/sonic-agent/blob/main/src/main/java/org/cloud/sonic/agent/tests/handlers/IOSStepHandler.java" target="_blank" rel="noreferrer">IOSStepHandler</a></p></div><h4 id="扩展能力" tabindex="-1">扩展能力 <a class="header-anchor" href="#扩展能力" aria-hidden="true">#</a></h4><p>StepHandler以外能力，可以直接import对应包或者直接引用进行实现。</p><p>包括但不限于：</p><ol><li>RestTemaplate，可以进行Rest Api操作。</li><li>Java自带的Process，可以运行本地指令。</li><li>SibTool，用于使用sib的工具类。</li><li>AndroidDeviceBridgeTool，用于操作adb的部分工具类。</li><li>fastJson和其他包等等。</li></ol><h3 id="输出日志到测试报告" tabindex="-1">输出日志到测试报告 <a class="header-anchor" href="#输出日志到测试报告" aria-hidden="true">#</a></h3><p>直接操作 <strong>androidStepHandler.log</strong> 使用</p><div class="language-groovy"><button title="Copy Code" class="copy"></button><span class="lang">groovy</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">log</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sendStepLog</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">我是普通日志</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">步骤详细日志</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">log</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sendStepLog</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">2</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">我是通过日志</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">步骤详细日志</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">log</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sendStepLog</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">3</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">我是告警日志</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">步骤详细日志</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">log</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sendStepLog</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">4</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">我是异常日志</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">步骤详细日志</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><p>入参分别为：<strong>日志级别</strong>、<strong>步骤简述</strong>、<strong>步骤详细日志</strong></p><p>日志级别有四种，从1-4分别是：INFO、PASS、WARN、ERROR</p><p>也可以提取LogUtil和StepType使用，使脚本更有可读性</p><div class="language-groovy"><button title="Copy Code" class="copy"></button><span class="lang">groovy</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sonic</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">agent</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">tests</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">LogUtil</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sonic</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">agent</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">common</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">interfaces</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">StepType</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">test</span><span style="color:#A6ACCD;">(){</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C792EA;">LogUtil</span><span style="color:#A6ACCD;"> log </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">log</span></span>
<span class="line"><span style="color:#A6ACCD;">  log</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sendStepLog</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">StepType</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">world</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  log</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sendStepLog</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">StepType</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">PASS</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">world</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  log</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sendStepLog</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">StepType</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">WARN</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">world</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">  log</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sendStepLog</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">StepType</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">ERROR</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">world</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span></code></pre></div><h3 id="引用全局参数" tabindex="-1">引用全局参数 <a class="header-anchor" href="#引用全局参数" aria-hidden="true">#</a></h3><p>全局参数默认存放在androidStepHandler.globalParams，是com.alibaba.fastjson.JSONObject对象。使用时可以直接</p><div class="language-groovy"><button title="Copy Code" class="copy"></button><span class="lang">groovy</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> test </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">globalParams</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">getString</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">log</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sendStepLog</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">获取全局参数Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">值：</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> test</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>更多全局参数与临时参数运用可以参考 <a href="https://sonic-cloud.wiki/d/2369" target="_blank" rel="noreferrer">这个帖子</a></p></div><h3 id="获取设备序列号" tabindex="-1">获取设备序列号 <a class="header-anchor" href="#获取设备序列号" aria-hidden="true">#</a></h3><p>Android:</p><div class="language-groovy"><button title="Copy Code" class="copy"></button><span class="lang">groovy</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> udId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">iDevice</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">getSerialNumber</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">log</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sendStepLog</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">获取udId</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">值：</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> udId</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><p>iOS:</p><div class="language-groovy"><button title="Copy Code" class="copy"></button><span class="lang">groovy</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> udId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> iosStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">udId</span></span>
<span class="line"><span style="color:#A6ACCD;">iosStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">log</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sendStepLog</span><span style="color:#89DDFF;">(</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">获取udId</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">值：</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;"> udId</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><h3 id="断言" tabindex="-1">断言 <a class="header-anchor" href="#断言" aria-hidden="true">#</a></h3><p>有assertEquals、assertNotEquals、assertNull、assertNotNull等等方法可以直接使用</p><div class="language-groovy"><button title="Copy Code" class="copy"></button><span class="lang">groovy</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">import static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">testng</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Assert</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">*;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#82AAFF;">assertEquals</span><span style="color:#A6ACCD;">(</span><span style="color:#F78C6C;">1+1</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">2</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"></span></code></pre></div><p>断言失败会抛出异常，并且自定义脚本步骤也会标记为失败</p><h3 id="退出driver" tabindex="-1">退出Driver <a class="header-anchor" href="#退出driver" aria-hidden="true">#</a></h3><p>如果在您的第三方工具中有基于instrument的框架（例如fastbot、uiautomator2-python、poco-service等等），会跟Sonic已有进程冲突导致阻塞状态，这时我们可以先停止Sonic的Driver。</p><h4 id="android" tabindex="-1">Android: <a class="header-anchor" href="#android" aria-hidden="true">#</a></h4><p>AndroidDriver有两种方式关闭:</p><ol><li>用内置函数关闭（推荐）</li></ol><div class="language-groovy"><button title="Copy Code" class="copy"></button><span class="lang">groovy</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sonic</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">agent</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">bridge</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">AndroidDeviceBridgeTool</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//停止Driver</span></span>
<span class="line"><span style="color:#A6ACCD;">androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">getAndroidDriver</span><span style="color:#89DDFF;">().</span><span style="color:#A6ACCD;">closeDriver</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//第三方操作</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// xxxxxx</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//重新启动Driver</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> port </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">AndroidDeviceBridgeTool</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">startUiaServer</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">iDevice</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">startAndroidDriver</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">iDevice</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> port</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><ol start="2"><li>用adb强制停止instrument服务（不推荐）</li></ol><div class="language-groovy"><button title="Copy Code" class="copy"></button><span class="lang">groovy</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sonic</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">agent</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">bridge</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">AndroidDeviceBridgeTool</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//停止UIAutomator2-server</span></span>
<span class="line"><span style="color:#C792EA;">AndroidDeviceBridgeTool</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">executeCommand</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">iDevice</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">am force-stop io.appium.uiautomator2.server</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#C792EA;">AndroidDeviceBridgeTool</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">executeCommand</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">iDevice</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">am force-stop io.appium.uiautomator2.server.test</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//第三方操作</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// xxxxxx</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//重新启动Driver</span></span>
<span class="line"><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> port </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">AndroidDeviceBridgeTool</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">startUiaServer</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">iDevice</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">startAndroidDriver</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">iDevice</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> port</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><h4 id="ios" tabindex="-1">iOS: <a class="header-anchor" href="#ios" aria-hidden="true">#</a></h4><div class="language-groovy"><button title="Copy Code" class="copy"></button><span class="lang">groovy</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sonic</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">agent</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">bridge</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">ios</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">SibTool</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//停止Driver</span></span>
<span class="line"><span style="color:#A6ACCD;">iosStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">closeIOSDriver</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//第三方操作</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// xxxxxx</span></span>
<span class="line"></span>
<span class="line"><span style="color:#676E95;font-style:italic;">//重新启动Driver</span></span>
<span class="line"><span style="color:#A6ACCD;">iosStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">startIOSDriver</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">udId</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">SibTool</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">startWda</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">udId</span><span style="color:#89DDFF;">)[</span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">])</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"></span></code></pre></div><h3 id="示例脚本展示" tabindex="-1">示例脚本展示 <a class="header-anchor" href="#示例脚本展示" aria-hidden="true">#</a></h3><h4 id="调用第三方rest-api" tabindex="-1">调用第三方Rest API <a class="header-anchor" href="#调用第三方rest-api" aria-hidden="true">#</a></h4><p>以下是使用RestTemplate调用第三方Rest API后，对响应结果断言以及输出到测试报告的示例。</p><div class="language-groovy"><button title="Copy Code" class="copy"></button><span class="lang">groovy</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">com</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">alibaba</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">fastjson</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">JSONObject</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">http</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">HttpEntity</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">http</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">HttpHeaders</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">http</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">HttpMethod</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sonic</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">agent</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">tools</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">SpringTool</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">springframework</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">web</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">client</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">RestTemplate</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sonic</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">agent</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">tests</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">LogUtil</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sonic</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">agent</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">common</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">interfaces</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">StepType</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F78C6C;">import static</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">testng</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">Assert</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">*;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">testRestApi</span><span style="color:#A6ACCD;">(){</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">LogUtil</span><span style="color:#A6ACCD;"> log </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">  androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">log</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">RestTemplate</span><span style="color:#A6ACCD;"> restTemplate </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">SpringTool</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">getBean</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">RestTemplate</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">HttpHeaders</span><span style="color:#A6ACCD;"> headers </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">HttpHeaders</span><span style="color:#A6ACCD;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">      headers</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">add</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">SonicToken</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">xxxxxxx</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#C792EA;">JSONObject</span><span style="color:#A6ACCD;"> result </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> restTemplate</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">exchange</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">http://localhost:8094/api/controller/projects/list</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">HttpMethod</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">GET</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">HttpEntity&lt;&gt;</span><span style="color:#A6ACCD;">(headers)</span><span style="color:#89DDFF;">,</span><span style="color:#C792EA;">JSONObject</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">class</span><span style="color:#89DDFF;">).</span><span style="color:#A6ACCD;">getBody</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#82AAFF;">assertEquals</span><span style="color:#A6ACCD;">(result</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">getInteger</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">code</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">,</span><span style="color:#F78C6C;">2000</span><span style="color:#A6ACCD;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">      log</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sendStepLog</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">StepType</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">rest api assert</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">result: </span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">+</span><span style="color:#A6ACCD;">result</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">toJSONString</span><span style="color:#89DDFF;">())</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">testRestApi</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span></code></pre></div><h4 id="adb-shell操作" tabindex="-1">adb shell操作 <a class="header-anchor" href="#adb-shell操作" aria-hidden="true">#</a></h4><p>以下是对adb shell命令输出的示例，包括一次性输出以及持续性输出。</p><div class="language-groovy"><button title="Copy Code" class="copy"></button><span class="lang">groovy</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sonic</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">agent</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">bridge</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">AndroidDeviceBridgeTool</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sonic</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">agent</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">tests</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">LogUtil</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sonic</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">agent</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">common</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">interfaces</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">StepType</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">com</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">ddmlib</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">IShellOutputReceiver</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">java</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">util</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">concurrent</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">TimeUnit</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">test</span><span style="color:#A6ACCD;">(){</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">LogUtil</span><span style="color:#A6ACCD;"> log </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">log</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> out </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">AndroidDeviceBridgeTool</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">executeCommand</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">iDevice</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">wm size</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">        log</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sendStepLog</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">StepType</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Get screen size</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">out</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">testLong</span><span style="color:#A6ACCD;">(){</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">LogUtil</span><span style="color:#A6ACCD;"> log </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">log</span></span>
<span class="line"><span style="color:#A6ACCD;">        androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">iDevice</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">executeShellCommand</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">dumpsys window displays</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">IShellOutputReceiver</span><span style="color:#A6ACCD;">() {</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#C792EA;">@Override</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">addOutput</span><span style="color:#A6ACCD;">(</span><span style="color:#C792EA;">byte</span><span style="color:#A6ACCD;">[] </span><span style="color:#A6ACCD;font-style:italic;">bytes</span><span style="color:#A6ACCD;">, </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">i</span><span style="color:#A6ACCD;">, </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">i1</span><span style="color:#A6ACCD;">) {</span></span>
<span class="line"><span style="color:#A6ACCD;">                                </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> res </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;">(bytes, i, i1);</span></span>
<span class="line"><span style="color:#A6ACCD;">                                log</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sendStepLog</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">StepType</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Dump windows msg</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#C792EA;">@Override</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">flush</span><span style="color:#A6ACCD;">() {</span></span>
<span class="line"><span style="color:#A6ACCD;">                            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#C792EA;">@Override</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">isCancelled</span><span style="color:#A6ACCD;">() {</span></span>
<span class="line"><span style="color:#A6ACCD;">                                </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                            }</span></span>
<span class="line"><span style="color:#A6ACCD;">                        }</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">MILLISECONDS</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">test</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">testLong</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span></code></pre></div><h4 id="执行fastbot" tabindex="-1">执行fastbot <a class="header-anchor" href="#执行fastbot" aria-hidden="true">#</a></h4><p>下方展示了如何执行fastbot并将日志持续输出到测试报告，注意：执行前确保设备上有fastbot相关的jar哦，详情可以查看fastbot文档。</p><p>因为fastbot底层与uia2的instrumentation有冲突（虽然Sonic后续会做处理，但是最好还是避免冲突），所以先执行了closeDriver()，运行完毕后，再重新startDriver()</p><div class="language-groovy"><button title="Copy Code" class="copy"></button><span class="lang">groovy</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sonic</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">agent</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">bridge</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">AndroidDeviceBridgeTool</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sonic</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">agent</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">tests</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">LogUtil</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sonic</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">agent</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">common</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">interfaces</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">StepType</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">com</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">android</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">ddmlib</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">IShellOutputReceiver</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">java</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">util</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">concurrent</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">TimeUnit</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">testFastbot</span><span style="color:#A6ACCD;">(){</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">LogUtil</span><span style="color:#A6ACCD;"> log </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">log</span></span>
<span class="line"><span style="color:#A6ACCD;">        androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">getAndroidDriver</span><span style="color:#89DDFF;">().</span><span style="color:#A6ACCD;">closeDriver</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">        androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">iDevice</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">executeShellCommand</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">CLASSPATH=/sdcard/monkeyq.jar:/sdcard/framework.jar:/sdcard/fastbot-thirdpart.jar exec app_process /system/bin com.android.commands.monkey.Monkey -p package_name --agent reuseq --running-minutes duration(min) --throttle delay(ms) -v -v</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">                        </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">IShellOutputReceiver</span><span style="color:#A6ACCD;">() {</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#C792EA;">@Override</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">addOutput</span><span style="color:#A6ACCD;">(</span><span style="color:#C792EA;">byte</span><span style="color:#A6ACCD;">[] </span><span style="color:#A6ACCD;font-style:italic;">bytes</span><span style="color:#A6ACCD;">, </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">i</span><span style="color:#A6ACCD;">, </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">i1</span><span style="color:#A6ACCD;">) {</span></span>
<span class="line"><span style="color:#A6ACCD;">                                </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> res </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;">(bytes, i, i1);</span></span>
<span class="line"><span style="color:#A6ACCD;">                                log</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sendStepLog</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">StepType</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">FastBot log</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">res</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#C792EA;">@Override</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">void</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">flush</span><span style="color:#A6ACCD;">() {</span></span>
<span class="line"><span style="color:#A6ACCD;">                            }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#C792EA;">@Override</span></span>
<span class="line"><span style="color:#A6ACCD;">                            </span><span style="color:#C792EA;">public</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">boolean</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">isCancelled</span><span style="color:#A6ACCD;">() {</span></span>
<span class="line"><span style="color:#A6ACCD;">                                </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                            }</span></span>
<span class="line"><span style="color:#A6ACCD;">                        }</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">TimeUnit</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">MILLISECONDS</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#C792EA;">int</span><span style="color:#A6ACCD;"> port </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">AndroidDeviceBridgeTool</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">startUiaServer</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">iDevice</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">        androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">startAndroidDriver</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;">androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">iDevice</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> port</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">testFastbot</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span></code></pre></div><h4 id="运行本地command指令" tabindex="-1">运行本地command指令 <a class="header-anchor" href="#运行本地command指令" aria-hidden="true">#</a></h4><p>以下是运行Agent本地PC指令和运行指令后持续输出指令结果到测试报告的示例。</p><div class="language-groovy"><button title="Copy Code" class="copy"></button><span class="lang">groovy</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sonic</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">agent</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">tests</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">LogUtil</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">org</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">cloud</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">sonic</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">agent</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">common</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">interfaces</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">StepType</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">java</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">io</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">IOException</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">java</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">io</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">InputStreamReader</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F78C6C;">import</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">java</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">io</span><span style="color:#89DDFF;">.</span><span style="color:#C792EA;">BufferedReader</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">testCmd</span><span style="color:#A6ACCD;">(){</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> system </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">getProperty</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">os.name</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">).</span><span style="color:#A6ACCD;">toLowerCase</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> (system</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">contains</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">win</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">) {</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">Runtime</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">getRuntime</span><span style="color:#89DDFF;">().</span><span style="color:#A6ACCD;">exec</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">cmd /c calc</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            } </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#C792EA;">Runtime</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">getRuntime</span><span style="color:#89DDFF;">().</span><span style="color:#A6ACCD;">exec</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">sh -c echo Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            }</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#F07178;">testCmdForLongTime</span><span style="color:#A6ACCD;">(){</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">LogUtil</span><span style="color:#A6ACCD;"> log </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;">  androidStepHandler</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">log</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">Process</span><span style="color:#A6ACCD;"> ps </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> system </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">System</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">getProperty</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">os.name</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">).</span><span style="color:#A6ACCD;">toLowerCase</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> (system</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">contains</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">win</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">) {</span></span>
<span class="line"><span style="color:#A6ACCD;">                ps </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Runtime</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">getRuntime</span><span style="color:#89DDFF;">().</span><span style="color:#A6ACCD;">exec</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">cmd /c calc</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            } </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#A6ACCD;"> {</span></span>
<span class="line"><span style="color:#A6ACCD;">                ps </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">Runtime</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">getRuntime</span><span style="color:#89DDFF;">().</span><span style="color:#A6ACCD;">exec</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">sh -c echo Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            }</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">InputStreamReader</span><span style="color:#A6ACCD;"> inputStreamReader </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">InputStreamReader</span><span style="color:#A6ACCD;">(ps</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">getInputStream</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">BufferedReader</span><span style="color:#A6ACCD;"> stdInput </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">new</span><span style="color:#A6ACCD;"> </span><span style="color:#C792EA;">BufferedReader</span><span style="color:#A6ACCD;">(inputStreamReader);</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#C792EA;">String</span><span style="color:#A6ACCD;"> s;</span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;font-style:italic;">while</span><span style="color:#A6ACCD;"> (ps</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">isAlive</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">) {</span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;font-style:italic;">try</span><span style="color:#A6ACCD;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">                    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> ((s </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> stdInput</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">readLine</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">) </span><span style="color:#89DDFF;">!=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">null</span><span style="color:#A6ACCD;">) {</span></span>
<span class="line"><span style="color:#A6ACCD;">                        log</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">sendStepLog</span><span style="color:#89DDFF;">(</span><span style="color:#C792EA;">StepType</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">INFO</span><span style="color:#89DDFF;">,</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">ps msg</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;">s</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">                    }</span></span>
<span class="line"><span style="color:#A6ACCD;">                } </span><span style="color:#89DDFF;font-style:italic;">catch</span><span style="color:#A6ACCD;"> (</span><span style="color:#C792EA;">IOException</span><span style="color:#A6ACCD;"> e) {</span></span>
<span class="line"><span style="color:#A6ACCD;">                    e</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">printStackTrace</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">                }</span></span>
<span class="line"><span style="color:#A6ACCD;">            }</span></span>
<span class="line"><span style="color:#A6ACCD;">            stdInput</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">close</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">            inputStreamReader</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">close</span><span style="color:#89DDFF;">()</span><span style="color:#A6ACCD;">;</span></span>
<span class="line"><span style="color:#A6ACCD;">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">testCmd</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">testCmdForLongTime</span><span style="color:#89DDFF;">()</span></span>
<span class="line"></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">更多参考示例</p><p>想参考更多脚本示例，可以前往 <a href="https://sonic-cloud.wiki/t/script" target="_blank">这里</a> 查看官方或用户分享的示例哦！</p></div><h2 id="二、python脚本" tabindex="-1">二、Python脚本 <a class="header-anchor" href="#二、python脚本" aria-hidden="true">#</a></h2><h3 id="能力介绍-1" tabindex="-1">能力介绍 <a class="header-anchor" href="#能力介绍-1" aria-hidden="true">#</a></h3><div class="info custom-block"><p class="custom-block-title">对比Groovy脚本</p><p>Python不能作为Agent内置引擎，因此不可使用Agent内置的方法与包。Python脚本只能使用Agent传递的部分参数，并且依赖需要自行本地安装，与Groovy脚本相比灵活性大大降低。</p></div><h3 id="前置环境" tabindex="-1">前置环境 <a class="header-anchor" href="#前置环境" aria-hidden="true">#</a></h3><p>Python环境、pip环境。</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>注意！如果Agent部署在Windows系统，注意设置Python环境输出字符集为UTF-8以避免脚本输出内容乱码。在启动Agent前执行</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#82AAFF;">set</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">PYTHONIOENCODING=UTF-</span><span style="color:#F78C6C;">8</span></span>
<span class="line"></span></code></pre></div><p>为Python环境设置环境变量。</p></div><h3 id="可用参数" tabindex="-1">可用参数 <a class="header-anchor" href="#可用参数" aria-hidden="true">#</a></h3><p>无论安卓还是iOS，Sonic会传递四个参数到Python脚本中，arg依次分别为：</p><ol><li>sessionId。安卓为uia2的sessionId，iOS为wda的sessionId。</li><li>设备udId。</li><li>全局参数Json字符串。</li><li>远程url地址（v2.5.3更新后可用）</li></ol><h3 id="退出driver-1" tabindex="-1">退出Driver <a class="header-anchor" href="#退出driver-1" aria-hidden="true">#</a></h3><p>如果在您的第三方工具中有基于instrument的框架（例如fastbot、uiautomator2-python、poco-service等等），会跟Sonic已有进程冲突导致阻塞状态，这时我们可以先停止Sonic的Driver。</p><h4 id="android-1" tabindex="-1">Android: <a class="header-anchor" href="#android-1" aria-hidden="true">#</a></h4><p>用adb强制停止instrument服务</p><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> os</span></span>
<span class="line"><span style="color:#A6ACCD;">udId </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> sys</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">argv</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">:][</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">]</span></span>
<span class="line"><span style="color:#A6ACCD;">os</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">system</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">adb -s </span><span style="color:#F78C6C;">{udId}</span><span style="color:#C3E88D;"> shell am force-stop io.appium.uiautomator2.server</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">format</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">udId</span><span style="color:#89DDFF;">))</span></span>
<span class="line"><span style="color:#A6ACCD;">os</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">system</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">adb -s </span><span style="color:#F78C6C;">{udId}</span><span style="color:#C3E88D;"> am force-stop io.appium.uiautomator2.server.test</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">format</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">udId</span><span style="color:#89DDFF;">))</span></span>
<span class="line"></span></code></pre></div><h3 id="示例脚本展示-1" tabindex="-1">示例脚本展示 <a class="header-anchor" href="#示例脚本展示-1" aria-hidden="true">#</a></h3><h4 id="直接用sonic已启动的appium-uiautomator2-server测试" tabindex="-1">直接用Sonic已启动的appium-uiautomator2-server测试 <a class="header-anchor" href="#直接用sonic已启动的appium-uiautomator2-server测试" aria-hidden="true">#</a></h4><p>以下是直接用Sonic已启动的appium-uiautomator2-server测试的示例脚本。</p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">pip install -U sonic-uia2-client</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><div class="language-python"><button title="Copy Code" class="copy"></button><span class="lang">python</span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> sys</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> os</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> common</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">models </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> AndroidSelector</span></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">from</span><span style="color:#A6ACCD;"> uia2</span><span style="color:#89DDFF;">.</span><span style="color:#A6ACCD;">driver </span><span style="color:#89DDFF;font-style:italic;">import</span><span style="color:#A6ACCD;"> AndroidDriver</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">def</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">test_demo</span><span style="color:#89DDFF;">(</span><span style="color:#A6ACCD;font-style:italic;">adb_serial_num</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">str</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">uia_url</span><span style="color:#89DDFF;">:</span><span style="color:#FFCB6B;">str</span><span style="color:#89DDFF;">):</span></span>
<span class="line"><span style="color:#A6ACCD;">    package_name </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">com.android.settings</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 启动 App</span></span>
<span class="line"><span style="color:#A6ACCD;">    os</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">system</span><span style="color:#89DDFF;">(</span></span>
<span class="line"><span style="color:#82AAFF;">        </span><span style="color:#C792EA;">f</span><span style="color:#C3E88D;">&quot;adb -s </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">adb_serial_num</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;"> shell monkey -p </span><span style="color:#F78C6C;">{</span><span style="color:#82AAFF;">package_name</span><span style="color:#F78C6C;">}</span><span style="color:#C3E88D;"> -c android.intent.category.LAUNCHER 1&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># 连接到已有 uia2 server</span></span>
<span class="line"><span style="color:#A6ACCD;">    driver </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#82AAFF;">AndroidDriver</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">uia_url</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    p </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> driver</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get_page_source</span><span style="color:#89DDFF;">()</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">p</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    e </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> driver</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">find_element</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">AndroidSelector</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">XPATH</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">//*[@text=&#39;设置&#39;]</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> e </span><span style="color:#89DDFF;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">not</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">None:</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">get_text</span><span style="color:#89DDFF;">())</span></span>
<span class="line"><span style="color:#A6ACCD;">        e</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">send_keys</span><span style="color:#89DDFF;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">Hello</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#A6ACCD;"> __name__ </span><span style="color:#89DDFF;">==</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">__main__</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># uia_url 在 v2.5.3 更新后才有</span></span>
<span class="line"><span style="color:#A6ACCD;">    session_id</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> adb_serial_num</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> global_pramas</span><span style="color:#89DDFF;">,</span><span style="color:#A6ACCD;"> uia_url </span><span style="color:#89DDFF;">=</span><span style="color:#A6ACCD;"> sys</span><span style="color:#89DDFF;">.</span><span style="color:#F07178;">argv</span><span style="color:#89DDFF;">[</span><span style="color:#F78C6C;">1</span><span style="color:#89DDFF;">:]</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">print</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">session_id</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> adb_serial_num</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> global_pramas</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> uia_url</span><span style="color:#89DDFF;">)</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">test_demo</span><span style="color:#89DDFF;">(</span><span style="color:#82AAFF;">adb_serial_num</span><span style="color:#89DDFF;">,</span><span style="color:#82AAFF;"> uia_url</span><span style="color:#89DDFF;">)</span></span>
<span class="line"></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">更多参考示例</p><p>想参考更多脚本示例，可以前往 <a href="https://sonic-cloud.wiki/t/script" target="_blank">这里</a> 查看官方或用户分享的示例哦！</p></div><h2 id="导入模板" tabindex="-1">导入模板 <a class="header-anchor" href="#导入模板" aria-hidden="true">#</a></h2><p>在【脚本模板】页面管理的脚本模板，可以在编辑时导入使用，导入有两种模式：</p><ol><li>追加，将模板追加到当前编辑脚本中</li><li>替换，将模板替换当前编辑脚本</li></ol><h2 id="使用规范与建议" tabindex="-1">使用规范与建议 <a class="header-anchor" href="#使用规范与建议" aria-hidden="true">#</a></h2><p>为了减少在使用时的维护成本，Sonic组织推荐脚本管理方式如下：</p><ol><li>将通用的方法/函数可以保存到【脚本模块管理】。</li><li>使用脚本时使用导入模块，将方法/函数追加到当前脚本中，并引用。</li><li>推荐重复引用的参数、方法提取出来维护。</li></ol>`,85),e=[p];function t(r,c,D,y,C,F){return n(),a("div",null,e)}const d=s(o,[["render",t]]);export{i as __pageData,d as default};
