import{_ as e,o as l,c as s,a}from"./app.57a3dbd1.js";const u=JSON.parse('{"title":"版本迁移指南","description":"","frontmatter":{"contributors":["ZhouYixun","wuxiangin"]},"headers":[{"level":2,"title":"关于版本规则变动","slug":"关于版本规则变动","link":"#关于版本规则变动","children":[]},{"level":2,"title":"从 v2.5.x 升级到 v2.6.x","slug":"从-v2-5-x-升级到-v2-6-x","link":"#从-v2-5-x-升级到-v2-6-x","children":[]},{"level":2,"title":"从 v2.3.x ~ v2.4.x 升级到 v2.5.x","slug":"从-v2-3-x-v2-4-x-升级到-v2-5-x","link":"#从-v2-3-x-v2-4-x-升级到-v2-5-x","children":[]},{"level":2,"title":"从 v1.4.1-release 以上版本 升级到 v2.0.x ~ v2.3.x","slug":"从-v1-4-1-release-以上版本-升级到-v2-0-x-v2-3-x","link":"#从-v1-4-1-release-以上版本-升级到-v2-0-x-v2-3-x","children":[]},{"level":2,"title":"其他旧版本升级到 v1.4.1-release","slug":"其他旧版本升级到-v1-4-1-release","link":"#其他旧版本升级到-v1-4-1-release","children":[]},{"level":2,"title":"其他旧版本升级到 v1.4.0-release","slug":"其他旧版本升级到-v1-4-0-release","link":"#其他旧版本升级到-v1-4-0-release","children":[]},{"level":2,"title":"关于 simple 版本","slug":"关于-simple-版本","link":"#关于-simple-版本","children":[]},{"level":2,"title":"常见问题（Q&A）","slug":"常见问题-q-a","link":"#常见问题-q-a","children":[]}],"relativePath":"deploy/upgrade-deploy.md","lastUpdated":1716537034000}'),n={name:"deploy/upgrade-deploy.md"},o=a(`<h1 id="版本迁移指南" tabindex="-1">版本迁移指南 <a class="header-anchor" href="#版本迁移指南" aria-hidden="true">#</a></h1><p>本文将介绍如何升级到最新版本。</p><h2 id="关于版本规则变动" tabindex="-1">关于版本规则变动 <a class="header-anchor" href="#关于版本规则变动" aria-hidden="true">#</a></h2><p>v2.0.0-release 起，Sonic 版本规则更改如下：</p><ol><li>第一位是大版本号，基本为一年一更</li><li>第二位是有新功能合入就会加 1（特性版本，一般月更）</li><li>第三位是修复 Bug 就会加 1（修复版本，一般半周到一周更一次）</li></ol><p>以 <code>v2.0.1</code> 为例，就是修复 <code>v2.0.0</code> 的 Bug。</p><p>如果有大量新功能发布，就会更新 <code>v2.1.0</code>。</p><p>如果 <code>v2.1.0</code> 上线后有 Bug，那么下版本就是 <code>v2.1.1</code>，如果仍有 Bug，那么会继续发布 <code>v2.1.2</code>。</p><p><strong>如果想追求稳定的版本，那么应该是上一个特性版本的最后一个修复版本为最稳定。</strong></p><p>例如 <code>v2.2.0</code> 的上一个版本为 <code>v2.1.15</code>，那么 <code>v2.1.15</code> 版本就是 <code>v2.1.x</code> 的最稳定的版本</p><h2 id="从-v2-5-x-升级到-v2-6-x" tabindex="-1">从 v2.5.x 升级到 v2.6.x <a class="header-anchor" href="#从-v2-5-x-升级到-v2-6-x" aria-hidden="true">#</a></h2><ol><li>升级前先备份Mysql数据库。</li><li>直接前往 <a href="https://sonic-cloud.cn/deploy/back-end-deploy.html" target="_blank">这里</a> 下载最新版本zip，down集群后重新up即可。如果更换了部署目录，旧目录下的<code>keepFiles</code>、<code>imageFiles</code>、<code>recordFiles</code>、<code>packageFiles</code>文件夹的内容也要同步到新目录下（部署文档含中国大陆加速镜像部署方式）</li><li>Agent可前往 <a href="https://sonic-cloud.cn/deploy/agent-deploy.html" target="_blank">这里</a> 下载zip后解压，更新需替换旧版本plugins文件夹与jar文件。Docker版Agent与server同理，前往 <a href="https://sonic-cloud.cn/deploy/agent-deploy.html" target="_blank">这里</a> 重新下载镜像部署即可。（部署文档含中国大陆加速镜像部署方式）</li></ol><h2 id="从-v2-3-x-v2-4-x-升级到-v2-5-x" tabindex="-1">从 v2.3.x ~ v2.4.x 升级到 v2.5.x <a class="header-anchor" href="#从-v2-3-x-v2-4-x-升级到-v2-5-x" aria-hidden="true">#</a></h2><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>升级至<code>v2.5.3</code>时，为了降低用户部署成本，在Agent中内置了adb程序，config配置难度也降低，可前往部署文档查看。</p></div><ol><li>升级前先备份Mysql数据库。</li><li>直接前往 <a href="https://sonic-cloud.cn/deploy/back-end-deploy.html" target="_blank">这里</a> 下载最新版本zip，down集群后重新up即可。如果更换了部署目录，旧目录下的<code>keepFiles</code>、<code>imageFiles</code>、<code>recordFiles</code>、<code>packageFiles</code>文件夹的内容也要同步到新目录下（部署文档含中国大陆加速镜像部署方式）</li><li>Agent jar部署的jdk要求提升至 <strong>jdk17</strong>，可前往 <a href="https://sonic-cloud.cn/deploy/agent-deploy.html" target="_blank">这里</a> 下载zip后解压，更新需替换旧版本plugins文件夹与jar文件。Docker版Agent与server同理，前往 <a href="https://sonic-cloud.cn/deploy/agent-deploy.html" target="_blank">这里</a> 重新下载镜像部署即可。（部署文档含中国大陆加速镜像部署方式）</li><li>Eureka默认端口从9090变更至8761</li></ol><h2 id="从-v1-4-1-release-以上版本-升级到-v2-0-x-v2-3-x" tabindex="-1">从 v1.4.1-release 以上版本 升级到 v2.0.x ~ v2.3.x <a class="header-anchor" href="#从-v1-4-1-release-以上版本-升级到-v2-0-x-v2-3-x" aria-hidden="true">#</a></h2><ol><li>升级前先备份Mysql数据库。</li><li>直接前往 <a href="https://sonic-cloud.cn/deploy/back-end-deploy.html" target="_blank">这里</a> 下载最新版本zip，down集群后重新up即可。如果更换了部署目录，旧目录下的<code>keepFiles</code>、<code>imageFiles</code>、<code>recordFiles</code>、<code>packageFiles</code>文件夹的内容也要同步到新目录下（部署文档含中国大陆加速镜像部署方式）</li><li>jar方式部署的Agent前往 <a href="https://sonic-cloud.cn/deploy/agent-deploy.html" target="_blank">这里</a> 下载zip后解压，更新需替换旧版本plugins文件夹与jar文件。Docker版Agent与server同理，前往 <a href="https://sonic-cloud.cn/deploy/agent-deploy.html" target="_blank">这里</a> 重新下载镜像部署即可。（部署文档含中国大陆加速镜像部署方式）</li></ol><div class="tip custom-block"><p class="custom-block-title">TIP</p><hr><p>升级至<code>v2.3.2</code>时，因数据结构调整，旧的安卓测试报告中的性能数据信息与新版本结构<strong>不兼容</strong>，因此会出现图表展示异常的问题。</p><hr><p>升级至<code>v2.3.x</code>时，因部分类目录迁移至<code>tests/handlers</code>下，可能引起自定义脚本引入包时出错，更改详情可查看 <a href="https://github.com/SonicCloudOrg/sonic-agent/tree/main/src/main/java/org/cloud/sonic/agent/tests/handlers" target="_blank" rel="noreferrer">这里</a>。</p><hr><p>从 v1.5.0或以下版本 升级需注意：</p><ol><li>env 文件最下方新增 LDAP_OBJECT_CLASS=person</li><li>Agent 端的 jar 部署方式：已知部分 JDK 出现不兼容的问题，Sonic 官方推荐使用 JDK15，可以前往 <a href="https://docs.aws.amazon.com/corretto/latest/corretto-15-ug/downloads-list.html" target="_blank" rel="noreferrer">这里</a> 安装下载。</li><li>Agent 的 config/application-sonic-agent.yml 字段有改动，需参考最新版 yml 备注进行配置。</li><li>Agent 本地环境不再依赖 node、npm、谷歌浏览器、chromedriver，可以卸载来减少 Agent 空间。</li></ol></div><h2 id="其他旧版本升级到-v1-4-1-release" tabindex="-1">其他旧版本升级到 v1.4.1-release <a class="header-anchor" href="#其他旧版本升级到-v1-4-1-release" aria-hidden="true">#</a></h2><ol start="0"><li>server 升级前，先备份数据库。</li><li><strong>注意！</strong> 升级后图片路径有所更改，所以旧图片会失效！</li></ol><div class="tip custom-block"><p class="custom-block-title">解决方案</p><ol><li>可以在数据库将旧图片路径的 <strong>ip:port</strong> 替换为 <strong>ip:前端 port/server</strong>，即可恢复（推荐）。</li><li>临时将 docker-compose.yml 文件的 gateway 服务，加上 ports 映射（不推荐），以下为示例代码：</li></ol></div><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-palenight"><code><span class="line"><span style="color:#A6ACCD;">sonic-server-gateway:</span></span>
<span class="line"><span style="color:#A6ACCD;">    image: &quot;registry.cn-hangzhou.aliyuncs.com/sonic-cloud/sonic-server-gateway:v1.4.1-beta&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">    hostname: sonic-server-gateway</span></span>
<span class="line"><span style="color:#A6ACCD;">    environment:</span></span>
<span class="line"><span style="color:#A6ACCD;">      - SONIC_EUREKA_USERNAME</span></span>
<span class="line"><span style="color:#A6ACCD;">      - SONIC_EUREKA_PASSWORD</span></span>
<span class="line"><span style="color:#A6ACCD;">      - SONIC_EUREKA_PORT</span></span>
<span class="line"><span style="color:#A6ACCD;">      - SONIC_EUREKA_HOST=sonic-server-eureka</span></span>
<span class="line"><span style="color:#A6ACCD;">      - SECRET_KEY</span></span>
<span class="line"><span style="color:#A6ACCD;">      - EXPIRE_DAY</span></span>
<span class="line"><span style="color:#A6ACCD;">    volumes:</span></span>
<span class="line"><span style="color:#A6ACCD;">      - ./logs/:/logs/</span></span>
<span class="line"><span style="color:#A6ACCD;">    depends_on:</span></span>
<span class="line"><span style="color:#A6ACCD;">      - sonic-server-eureka</span></span>
<span class="line"><span style="color:#A6ACCD;">    networks:</span></span>
<span class="line"><span style="color:#A6ACCD;">      - sonic-network</span></span>
<span class="line"><span style="color:#A6ACCD;">    restart: on-failure</span></span>
<span class="line"><span style="color:#A6ACCD;">    ports:</span></span>
<span class="line"><span style="color:#A6ACCD;">      - 8094:8094</span></span>
<span class="line"><span style="color:#A6ACCD;"></span></span></code></pre></div><ol start="2"><li>因新版本 <strong>将前后端多个端口合并为单一接口</strong> 暴露，配置时需注意。（注意 env 文件与 docker-compose.yml 文件都需要更换）</li><li>因整体架构调整较多，可前往 <strong>前后端部署</strong> 页面重新部署。</li><li>server 升级后，将旧挂载目录下的 logs、keepFiles、imageFiles、recordFiles、packageFiles 中的内容迁移到新目录下。</li><li>Agent 改动较大，需要将旧文件全部删除重新部署。配置 yml 时注意 server 的 port 应为 <strong>SONIC_SERVER_PORT</strong>。</li></ol><h2 id="其他旧版本升级到-v1-4-0-release" tabindex="-1">其他旧版本升级到 v1.4.0-release <a class="header-anchor" href="#其他旧版本升级到-v1-4-0-release" aria-hidden="true">#</a></h2><ol><li>server 升级前，先备份数据库。</li><li>因新版本调整设备数据，尽量将旧版本的 <strong>重复序列号(udId)</strong> 的设备删除至剩一个。（可查看下方常见问题）</li><li>因整体架构调整较多，可前往 <strong>前后端部署</strong> 页面重新部署。</li><li>server 升级后，将旧挂载目录下的 logs、keepFiles、imageFiles、recordFiles、packageFiles 中的内容迁移到新目录下。</li><li>如果旧版本没有自定义挂载路径（特别是 simple 版用户），您不知道您的本地文件默认储存在哪里，可以 <a href="https://blog.csdn.net/wu_qing_song/article/details/113253437" target="_blank" rel="noreferrer">参考这里</a> （如果你不想使用这个方法，可以参考常见问题第二题）。</li><li>Agent 改动较大，需要将旧文件全部删除重新部署。</li></ol><h2 id="关于-simple-版本" tabindex="-1">关于 simple 版本 <a class="header-anchor" href="#关于-simple-版本" aria-hidden="true">#</a></h2><p>综合注册架构、通信逻辑、性能优化等因素，从 v1.4.0-beta 开始，集群版与 simple 版合并，并且在 sonic-server 上继续维护，因此 sonic-server-simple 版本不再维护。</p><h2 id="常见问题-q-a" tabindex="-1">常见问题（Q&amp;A） <a class="header-anchor" href="#常见问题-q-a" aria-hidden="true">#</a></h2><p>Q1: 我如果不迁移上文提到的若干个文件夹，直接使用新版本自带的文件夹，会发生什么？</p><p>A1: 旧版本的图片、录像、截图等信息将失效。当然如果文件不多，直接用新版本也是可以的。</p><hr><p>Q2: 如果不用上文第四点的方法，还有别的方法吗？</p><p>A2: 可以使用 docker cp 指令将容器内的文件复制到宿主机，再迁移到新版本文件夹中。</p><hr><p>Q3: 为什么1.4.0之前旧版本升级需要删除重复的序列号设备？</p><p>A3: 旧版本是以单 Agent 内不可重复，后续考虑到用户会将同一设备在多个 Agent 之间迁移，直接以序列号为标识。安卓目前是极低概率才会出现序列号相同的设备（哪怕相同也有办法修改），而苹果的序列号都是唯一的，所以大家不用担心。</p><hr><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>更多疑问可前往 👉<a href="https://discord.gg/c9ZD6jSyTE" target="_blank" rel="noreferrer">社区</a>👈 交流</p></div>`,38),r=[o];function i(t,c,p,d,h,v){return l(),s("div",null,r)}const A=e(n,[["render",i]]);export{u as __pageData,A as default};
